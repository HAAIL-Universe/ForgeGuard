# ForgeGuard -- API Physics (v0.1)
# Canonical API specification. If it's not here, it doesn't exist.

info:
  title: "ForgeGuard API"
  version: "0.1.0"
  description: "Repository audit monitoring dashboard"

paths:

  # -- Health -------------------------------------------------------

  /health:
    get:
      summary: "Health check"
      auth: none
      response:
        status: "ok"

  /health/version:
    get:
      summary: "Return application version and current phase"
      auth: none
      response:
        version: string
        phase: string

  # -- Auth ---------------------------------------------------------

  /auth/github:
    get:
      summary: "Redirect to GitHub OAuth authorization page"
      auth: none
      response:
        redirect: "https://github.com/login/oauth/authorize?..."

  /auth/github/callback:
    get:
      summary: "Handle GitHub OAuth callback, exchange code for token, create/update user, return JWT"
      auth: none
      query:
        code: string (required)
        state: string (required)
      response:
        token: string
        user:
          id: uuid
          github_login: string
          avatar_url: string

  /auth/me:
    get:
      summary: "Return current user info from JWT"
      auth: bearer
      response:
        id: uuid
        github_login: string
        avatar_url: string

  # -- Repos --------------------------------------------------------

  /repos:
    get:
      summary: "List connected repos for the authenticated user"
      auth: bearer
      response:
        items: RepoWithHealth[]

  /repos/available:
    get:
      summary: "List GitHub repos available to connect (not yet connected)"
      auth: bearer
      response:
        items: GitHubRepo[]

  /repos/{repo_id}/connect:
    post:
      summary: "Connect a GitHub repo -- register webhook and start monitoring"
      auth: bearer
      request:
        github_repo_id: integer (required)
        full_name: string (required)
        default_branch: string (required)
      response:
        id: uuid
        full_name: string
        webhook_active: boolean

  /repos/{repo_id}/disconnect:
    delete:
      summary: "Disconnect a repo -- remove webhook and stop monitoring"
      auth: bearer
      response:
        status: "disconnected"

  # -- Audit Runs ---------------------------------------------------

  /repos/{repo_id}/audits:
    get:
      summary: "List audit runs for a repo, newest first"
      auth: bearer
      query:
        limit: integer (default 50)
        offset: integer (default 0)
      response:
        items: AuditRunSummary[]
        total: integer

  /repos/{repo_id}/audits/{audit_id}:
    get:
      summary: "Get full audit detail including all check results"
      auth: bearer
      response:
        id: uuid
        commit_sha: string
        commit_message: string
        commit_author: string
        branch: string
        status: string
        overall_result: string
        started_at: datetime
        completed_at: datetime
        files_checked: integer
        checks: AuditCheck[]

  # -- Webhooks -----------------------------------------------------

  /webhooks/github:
    post:
      summary: "Receive GitHub push webhook events"
      auth: webhook_signature (X-Hub-Signature-256)
      request:
        ref: string
        commits: GithubCommit[]
        repository: GithubRepository
      response:
        status: "accepted"

  # -- Governance Audit Runner --------------------------------------

  /audit/run:
    get:
      summary: "Trigger a governance audit run programmatically"
      auth: bearer
      query:
        claimed_files: string (required, comma-separated file paths)
        phase: string (default "unknown")
      response:
        phase: string
        timestamp: string
        overall: string
        checks: GovernanceCheckResult[]
        warnings: GovernanceCheckResult[]

  # -- WebSocket ----------------------------------------------------

  /ws:
    websocket:
      summary: "Real-time audit result updates"
      auth: bearer (via query param token)
      messages_from_server:
        type: "audit_update"
        payload: AuditRunSummary
        type: "file_created"
        payload: BuildFileEvent
        type: "build_plan"
        payload: BuildPlan
        type: "plan_task_complete"
        payload: PlanTaskUpdate
        type: "build_turn"
        payload: BuildTurnInfo
        type: "build_paused"
        payload: BuildPauseEvent
        type: "build_resumed"
        payload: BuildResumeEvent
        type: "build_interjection"
        payload: BuildInterjectionEvent

  # -- Projects (Phase 8) -------------------------------------------

  /projects:
    post:
      summary: "Create a new project"
      auth: bearer
      request:
        name: string (required, min 1, max 255)
        description: string (optional)
      response:
        id: uuid
        name: string
        description: string | null
        status: string
        created_at: datetime

    get:
      summary: "List user's projects"
      auth: bearer
      response:
        items: ProjectSummary[]

  /projects/{project_id}:
    get:
      summary: "Get project detail with contract status"
      auth: bearer
      response:
        id: uuid
        name: string
        description: string | null
        status: string
        repo_id: uuid | null
        questionnaire_progress: QuestionnaireProgress
        contracts: ContractSummary[]
        created_at: datetime
        updated_at: datetime

  /projects/{project_id}/questionnaire:
    post:
      summary: "Send a message to the questionnaire chat"
      auth: bearer
      request:
        message: string (required, min 1)
      response:
        reply: string
        section: string
        completed_sections: string[]
        remaining_sections: string[]
        is_complete: boolean

  /projects/{project_id}/questionnaire/state:
    get:
      summary: "Current questionnaire progress"
      auth: bearer
      response:
        current_section: string | null
        completed_sections: string[]
        remaining_sections: string[]
        is_complete: boolean

  /projects/{project_id}/contracts/generate:
    post:
      summary: "Generate all contract files from completed questionnaire answers"
      auth: bearer
      response:
        contracts: ContractSummary[]

  /projects/{project_id}/contracts:
    get:
      summary: "List generated contracts"
      auth: bearer
      response:
        items: ContractSummary[]

  /projects/{project_id}/contracts/{contract_type}:
    get:
      summary: "View a single contract"
      auth: bearer
      response:
        id: uuid
        project_id: uuid
        contract_type: string
        content: string
        version: integer
        created_at: datetime
        updated_at: datetime

    put:
      summary: "Edit a contract before build"
      auth: bearer
      request:
        content: string (required)
      response:
        id: uuid
        contract_type: string
        content: string
        version: integer
        updated_at: datetime

  # -- Builds (Phase 9) -----------------------------------------------

  /projects/{project_id}/build:
    post:
      summary: "Start a build (validates contracts exist, spawns builder)"
      auth: bearer
      request:
        target_type: string (required, enum: github_new, github_existing, local_path)
        target_ref: string (required, repo name / full_name / absolute path)
      response:
        id: uuid
        project_id: uuid
        phase: string
        status: string
        target_type: string
        target_ref: string
        started_at: datetime
        created_at: datetime

  /projects/{project_id}/build/cancel:
    post:
      summary: "Cancel an active build"
      auth: bearer
      response:
        id: uuid
        status: string

  /projects/{project_id}/build/resume:
    post:
      summary: "Resume a paused build with an action"
      auth: bearer
      request:
        action: string (required, enum: retry, retry_with_message, skip, abort)
        message: string (optional, user guidance for the builder)
      response:
        id: uuid
        status: string

  /projects/{project_id}/build/interject:
    post:
      summary: "Send a message to the builder mid-build"
      auth: bearer
      request:
        message: string (required)
      response:
        status: string

  /projects/{project_id}/build/status:
    get:
      summary: "Current build status (phase, progress, active/idle)"
      auth: bearer
      response:
        id: uuid
        project_id: uuid
        phase: string
        status: string
        loop_count: integer
        started_at: datetime | null
        completed_at: datetime | null
        error_detail: string | null
        created_at: datetime

  /projects/{project_id}/build/files:
    get:
      summary: "List all files written during the build"
      auth: bearer
      response:
        items: BuildFile[]

  /projects/{project_id}/build/files/{path}:
    get:
      summary: "Retrieve content of a specific file written during the build"
      auth: bearer
      response:
        path: string
        content: string
        size_bytes: integer
        language: string

  /projects/{project_id}/build/logs:
    get:
      summary: "Paginated build logs"
      auth: bearer
      query:
        limit: integer (default 100)
        offset: integer (default 0)
      response:
        items: BuildLogEntry[]
        total: integer

  # -- Build Summary & Instructions (Phase 11) --------------------------

  /projects/{project_id}/build/summary:
    get:
      summary: "Complete build summary with cost breakdown"
      auth: bearer
      response:
        build: BuildStatus
        cost: BuildCostSummary
        elapsed_seconds: float | null
        loop_count: integer

  /projects/{project_id}/build/instructions:
    get:
      summary: "Generated deployment instructions from project contracts"
      auth: bearer
      response:
        project_name: string
        instructions: string

# -- Schemas --------------------------------------------------------

schemas:

  HealthResponse:
    status: string

  RepoWithHealth:
    id: uuid
    full_name: string
    default_branch: string
    webhook_active: boolean
    health_score: string
    last_audit_at: datetime | null
    recent_pass_rate: float | null

  GitHubRepo:
    github_repo_id: integer
    full_name: string
    default_branch: string
    private: boolean

  AuditRunSummary:
    id: uuid
    commit_sha: string
    commit_message: string
    commit_author: string
    branch: string
    status: string
    overall_result: string | null
    started_at: datetime
    completed_at: datetime | null
    files_checked: integer

  AuditCheck:
    id: uuid
    check_code: string
    check_name: string
    result: string
    detail: string | null

  GithubCommit:
    id: string
    message: string
    author:
      name: string
      email: string
    added: string[]
    modified: string[]
    removed: string[]

  GithubRepository:
    id: integer
    full_name: string
    default_branch: string

  GovernanceCheckResult:
    code: string
    name: string
    result: string
    detail: string | null

  ProjectSummary:
    id: uuid
    name: string
    description: string | null
    status: string
    created_at: datetime
    updated_at: datetime

  QuestionnaireProgress:
    current_section: string | null
    completed_sections: string[]
    remaining_sections: string[]
    is_complete: boolean

  ContractSummary:
    id: uuid
    project_id: uuid
    contract_type: string
    version: integer
    created_at: datetime
    updated_at: datetime

  BuildLogEntry:
    id: uuid
    build_id: uuid
    timestamp: datetime
    source: string
    level: string
    message: string
    created_at: datetime

  BuildFile:
    path: string
    size_bytes: integer
    language: string
    created_at: datetime

  BuildStatus:
    id: uuid
    project_id: uuid
    phase: string
    status: string
    loop_count: integer
    target_type: string | null
    target_ref: string | null
    started_at: datetime | null
    completed_at: datetime | null
    error_detail: string | null
    created_at: datetime

  BuildCostSummary:
    total_input_tokens: integer
    total_output_tokens: integer
    total_cost_usd: float
    phases: BuildCostEntry[]

  BuildCostEntry:
    phase: string
    input_tokens: integer
    output_tokens: integer
    model: string
    estimated_cost_usd: float

  BuildPlan:
    tasks: BuildPlanTask[]

  BuildPlanTask:
    id: integer
    title: string
    status: string  # pending | done

  PlanTaskUpdate:
    task_id: integer
    status: string

  BuildTurnInfo:
    turn: integer
    total_tokens: integer
    compacted: boolean

  BuildPauseEvent:
    phase: string
    loop_count: integer
    audit_findings: string
    options: string[]

  BuildResumeEvent:
    action: string
    phase: string

  BuildInterjectionEvent:
    message: string
    injected_at: datetime
